<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Inflexion</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="todo">
    <meta name="author" content="todo">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="black">
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="msapplication-navbutton-color" content="black">
    <!-- Windows Phone -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!-- iOS Safari -->
    <link rel="manifest" href="todo.manifest">
    <link rel="apple-touch-icon" href="/static/icons/icon.png">
    <link rel="icon" href="/static/icons/favicon.png" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/3.1.1/socket.io.min.js"
        integrity="sha384-gDaozqUvc4HTgo8iZjwth73C6dDDeOJsAgpxBcMpZYztUfjHXpzrpdrHRdVp8ySO"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<body>
    <div class="container">
        <!-- Form to get input information to send to the Server -->
        <form id="inflexion_form" class="row needs-validation" method="post" novalidate>
            <!-- POS -->
            <!-- <div class="col-auto">
                <div class="form-floating">
                    <select class="form-select" name="pos" id="pos" required>
                        <option value="n">Noun</option>
                        <option value="v">Verb</option>
                        The additional space is because col-auto fails with form-floating when the 
                            label is longer than the longest value. In this case, it will put the label on two lines,
                            causing it to look horrible.
                        <option value="a">Adjective&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>
                    </select>
                    <label for="pos" class="form-label">Part of Speech</label>
                </div>
            </div> -->
            <div class="col-auto">
                <!-- <div class="form-control"> -->
                <label for="pos" class="form-label">Part of Speech</label>
                <select class="form-select" name="pos" id="pos" required>
                    <option value="n">Noun</option>
                    <option value="v">Verb</option>
                    <option value="a">Adjective</option>
                </select>
                <!-- </div> -->
            </div>

            <!-- Wordforms -->
            <!-- <div class="col-auto">
                <div class="form-floating">
                    <select class="form-select" name="wordform" id="wordform" required>
                        <option value="sing">To Singular</option>
                        <option value="plur">To Plural</option>
                        <option value="past" disabled>To Past</option>
                        <option value="past_part" disabled>To Past Participle</option>
                        <option value="pres_part" disabled>To Present Participle</option>
                    </select>
                    <label for="wordform" class="form-label">Wordform</label>
                    <div class="invalid-feedback">
                        Please select a valid wordform for this Part of Speech.
                    </div>
                </div>
            </div> -->
            <div class="col-auto">
                <!-- <div class="form-control"> -->
                <label for="wordform" class="form-label">Wordform</label>
                <select class="form-select" name="wordform" id="wordform" required>
                    <option value="sing">To Singular</option>
                    <option value="plur">To Plural</option>
                    <option value="past" disabled>To Past</option>
                    <option value="past_part" disabled>To Past Participle</option>
                    <option value="pres_part" disabled>To Present Participle</option>
                </select>
                <div class="invalid-feedback">
                    Please select a valid wordform for this Part of Speech.
                </div>
                <!-- </div> -->
            </div>

            <!-- Force next columns to break to new line when the page is small enough -->
            <div class="enter_one"></div>

            <!-- Word -->
            <!-- <div class="col">
                <div class="form-floating">
                    placeholder="" is required for the floating label
                    <input type="text" class="form-control long" name="word" id="word" placeholder="" required>
                    <label for="word" class="form-label">Word or Collocation</label>
                    <div class="invalid-feedback">
                        Please provide a word or collocation.
                    </div>
                </div>
            </div> -->
            <div class="col">
                <!-- <div class="form-control"> -->
                <label for="word" class="form-label">Word or Collocation</label>
                <input type="text" class="form-control long" name="word" id="word" placeholder=". . ." required>
                <div class="invalid-feedback">
                    Please provide a word or collocation.
                </div>
                <!-- </div> -->
            </div>

            <!-- Force next columns to break to new line when the page is small enough -->
            <div class="enter_two"></div>

            <!-- Random -->
            <div class="col-auto">
                <label for="random" class="form-label">&nbsp;</label>
                <button type="button" name="random" id="random" class="btn btn-outline-warning d-block">Random</button>
            </div>

            <!-- Go -->
            <div class="col-auto">
                <label for="go" class="form-label">&nbsp;</label>
                <button type="submit" id="go" class="btn btn-outline-success d-block">Go</button>
            </div>

            <!-- Random & Go with Line -->
            <!-- <div class="col-12 d-flex justify-content-center background">
                <button type="button" name="random" id="random" class="btn btn-outline-warning d-block">Random</button>
                <button type="submit" id="go" class="btn btn-outline-success d-block">Go</button>
            </div> -->

            <!-- Random & Go -->
            <!-- <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" name="random" id="random"
                        class="btn btn-outline-warning d-block">Random</button>
                    <button type="submit" id="go" class="btn btn-outline-success d-block">Go</button>
                </div>
            </div> -->
        </form>
        <!-- <hr> -->

        <!-- <div class="input-group">
        <div class="input-group-prepend">
            <span class="input-group-text">Correct Output</span>
        </div>

        <input type="text" class="form-control" placeholder="Output", aria-label="Output">

        <div class="input-group-append">
            <span class="input-group-text">12</span>
        </div>
    </div> -->

        <!-- <hr> -->

        <table class="table">
            <thead class="thead-light">
                <tr>
                    <th id="module_column" scope="col">
                        Module
                    </th>
                    <th scope="col">
                        Output
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr id="known_correct_row" style="display: none">
                    <td scope="col">
                        <span id="known_correct_module" class="input-group-text">Known correct</span>
                    </td>
                    <td scope="col">
                        <input id="known_correct_output" type="text" class="form-control" , aria-label="Output">
                    </td>
                    <!-- <td scope="col">
                        <span class="input-group-text">12</span>
                    </td> -->
                </tr>
                <!-- <hr> -->
                <!-- <div class="collapse" id="collapsable_rows"> -->
                {%- for module in modules %}
                <tr id={{ module + "_row" }} style="display: none">
                    <td scope="col">
                        <span class="input-group-text">{{ module }}</span>
                    </td>
                    <td scope="col">
                        <input id={{ module + "_output" }} type="text" class="form-control" , aria-label="Output">
                    </td>
                    <!-- <td scope="col">
                        <span class="input-group-text">12</span>
                    </td> -->
                </tr>
                {%- endfor %}
                <!-- </div> -->
            </tbody>
        </table>

        <!-- TODO: use jquery to override on-click to send "show competitors" to Server -->
        <!-- IDEA: Set a hidden form element's value -->
        <div class="col-auto d-flex justify-content-center background">
            <button class="btn btn-outline-dark" type="button" id="competitors_button">Show Competitors</button>
        </div>

        <!-- <h2 class="background"><span>Show Competitors</span></h2> -->
    </div>

    <p id="modules" hidden>{{ modules | safe }}</p>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"
        integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"
        integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG"
        crossorigin="anonymous"></script>
</body>
<script>
    $(document).ready(function () {

        // Get array of used modules
        const modules = JSON.parse($("#modules").text().replace(/'/g, '"'));

        // Set width for module column in table
        var character_count = modules.map(x => x.length).reduce((accum, current_val) => Math.max(accum, current_val), $("#known_correct_module").text().length);
        $("#module_column").css("width", `${character_count * 10}px`);

        // Get array of the currently correct words (can be multiple, i.e. brother/brethren)
        var currently_correct = [];

        var show_competitors = false;

        // sending a connect request to the server.
        var socket = io.connect('http://localhost:5000');

        // Emit the request for output given the current inputs
        function emit_input() {
            // Set form validation
            var form = $('#inflexion_form')[0];
            form.classList.add('was-validated');
            if (!form.checkValidity()) {
                return;
            }

            socket.emit("input", {
                pos: $("#pos").val(),
                wordform: $("#wordform").val(),
                word: $("#word").val(),
                show_competitors: show_competitors,
            });

            clear_all_outputs();
        }

        // Emit the request for which modules should be shown
        function emit_input_modules() {
            socket.emit("input_modules", {
                pos: $("#pos").val(),
                wordform: $("#wordform").val(),
                show_competitors: show_competitors
            });
        }

        // Apply is-valid or is-invalid class based on value as compared to currently_correct
        function validate(output) {
            if (currently_correct.length) {
                var value = output.val()
                if (value) {
                    if (currently_correct.includes(value)) {
                        output.addClass("is-valid");
                    }
                    else {
                        output.addClass("is-invalid");
                    }
                }
            }
        }

        // Disable Past, Past Participle and Present Participle if a POS other than Verb is selected
        function toggle_wordform_disabled(value) {
            const disabled_wordforms = ["past", "past_part", "pres_part"]
            if (value == "v") {
                disabled_wordforms.forEach(word_form => {
                    $(`#wordform option[value='${word_form}']`).prop('disabled', false);
                });
            }
            else {
                disabled_wordforms.forEach(word_form => {
                    $(`#wordform option[value='${word_form}']`).prop('disabled', true);
                });
                // If one of the wordforms that will be disabled has been selected, reset to "sing" aka "To Singular"
                var wordform_selector = $('#wordform')[0];
                if (disabled_wordforms.includes(wordform_selector.value)) {
                    wordform_selector.value = "sing";
                }
            }
        }

        // Show the Known Correct row, but only if all visible outputs are incorrect.
        function opt_show_correct() {
            if (currently_correct.length) {
                // Return if there exists a visible row with no output, 
                // or if there is a visible row that is correct
                for (i = 0; i < modules.length; i++) {
                    var module = modules[i];
                    var row = $(`#${module}_row`);
                    if (row.is(":visible")) {
                        var output = $(`#${module}_output`);
                        if (output.hasClass("is-valid") || output.val().length == 0) {
                            return;
                        }
                    }
                }

                // Otherwise, show known correct
                $("#known_correct_row").show();
            }
        }

        // Straight away find which modules can be used
        emit_input_modules();

        // Reset all formatting classes from this output
        function reset_output_classes(output) {
            output.removeClass("italic");
            output.removeClass("is-invalid");
            output.removeClass("is-valid");
            output.removeClass("is-warning");
        }

        // Clear the output field for all modules, including italic and colors
        function clear_all_outputs() {
            currently_correct = [];
            $("#known_correct_output").val("");
            reset_output_classes($("#known_correct_output"));
            $("#known_correct_row").hide();

            modules.forEach(module => {
                var output = $(`#${module}_output`);
                output.val("");
                reset_output_classes(output);
            });
        }

        // Update which Wordform options are allowed, given the current POS,
        // also find out which modules should be shown given the current POS and Wordform
        $('#pos').change(function () {
            toggle_wordform_disabled(this.value);

            // Emit the request for which modules should be shown
            emit_input_modules();
        });

        // Find out which modules should be shown given the current POS and Wordform
        $('#wordform').change(function () {
            // Emit the request for which modules should be shown
            emit_input_modules();
        });

        // Override show competitors button click to request new input modules
        $('#competitors_button').unbind("click").bind("click", function () {
            show_competitors = !show_competitors;
            $('#competitors_button').text(show_competitors ? "Hide Competitors" : "Show Competitors");
            emit_input_modules();

            // If we are now going to show competitors, and we already have a word filled out, then do Go
            if ($("#word")[0].value) {
                emit_input();
            }
        });

        // Override Random button click to send "Random" request to Server
        $('#random').unbind("click").bind("click", function () {
            socket.emit("random", {
                show_competitors: show_competitors
            });
        });

        // After successfully connecting to the Server
        socket.on('after connect', function (msg) {
            console.log('Successfully connected to server.');
        });

        // Getting input parameters from the random choice from the Server
        socket.on('conversion', function (json) {
            $('#pos').val(json["pos"]);
            toggle_wordform_disabled(json["pos"]);
            $('#wordform')[0].value = json["wordform"];
            $('#word').val(json["word"]);
            // Set was-validated to give the inputs color
            var form = $('#inflexion_form')[0];
            form.classList.add('was-validated');
        });

        // Getting outputs from the Server
        socket.on('output', function (json) {
            // console.log("Received output: ");
            // console.log(json);
            var output = $(`#${json['module']}_output`);
            if (json["output"]) {
                reset_output_classes(output);
                output.val(json["output"]);
                validate(output);
            }
            else {
                output.addClass("italic");
                output.addClass("is-warning");
                output.val("Output was an empty string.");
            }

            // Optionally show known correct table row
            opt_show_correct();
        });

        // Getting the known correct output from the Server
        socket.on('correct', function (json) {
            var output = $(`#known_correct_output`);
            currently_correct = json["output"];

            output.addClass("is-valid");
            output.val(currently_correct.join(", "));

            // Set is-valid or is-invalid on already filled in outputs
            modules.forEach(module => {
                var output = $(`#${module}_output`);
                validate(output);
            });

            // Optionally show known correct table row
            opt_show_correct();
        });

        // Getting which modules should be visible from the Server
        socket.on('output_modules', function (json) {
            clear_all_outputs();
            modules.forEach(module => {
                if (json["modules"].includes(module)) {
                    $(`#${module}_row`).show();
                }
                else {
                    $(`#${module}_row`).hide();
                }
            });
        });

        // Override Submit and send the inputs to the Server
        $('#inflexion_form').submit(function (e) {
            e.preventDefault();
            emit_input();
        });
    });

</script>

</html>